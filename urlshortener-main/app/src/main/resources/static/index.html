<!DOCTYPE html>
<html lang="es">
<head>
    <title>URL Shortener</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="webjars/bootstrap/3.4.0/css/bootstrap.min.css" rel="stylesheet"
          type="text/css"/>
    <script src="webjars/jquery/3.6.1/jquery.min.js" type="text/javascript"></script>
    <script src="webjars/bootstrap/3.4.0/js/bootstrap.min.js"
            type="text/javascript"></script>
    <script src="js/app.js" type="text/javascript">
    </script>

    <style>
        /* Personalizamos a 30% el ancho del form control*/
        .input-half-width.form-control {
            width: 30%;
        }
    </style>

</head>
<body>
<div class="container-full">
    <div class="row">
        <div class="col-lg-12 text-center">
            <h1>URL Shortener</h1>
            <p class="lead">A front-end example page for the project</p>
            <br>
          
            <form action="" id="shortener" role="form">
                <div class="form-row align-items-center">
                    <div class="">
                        <input class="center-block form-control input-lg input-half-width" name="url" id="url"
                           placeholder="Enter a URL" title="Enter a URL" type="text">

                        <input class="center-block form-control input-lg input-half-width" name="alias"
                           placeholder="If you want a special name" type="text" id="inputAlias">

                    </div>
                    <div class="col-auto">
                        <!-- Basado en https://getbootstrap.com/docs/5.0/forms/checks-radios/ -->
                        <div class="form-check">
                            <input class="form-check-input" name="qr" id="QRcheckbox"
                                   type="checkbox">
                            <label class="form-check-label" for="QRcheckbox">
                                Get QR!
                            </label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <span class="input-group-btn">
                            <button class="btn btn-lg btn-primary" type="submit" id="short">Short me!</button>
                        </span>
                    </div>
                </div>


            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12 text-center">
            <div class="col-sm-offset-4 col-sm-4 text-center">
                <br/>
                <div id="result"></div>
            </div>
        </div>
    </div>
    
</div>
    <div class="col-lg-12 text-center">
        <h1>Bulk url conversion</h1>
        <input type="file" id="csvFile" accept=".csv" class="center-block">
        <label for="selector">Choose a value:</label>
        <select id="selector">
            <option value="a">Url shortener</option>
            <option value="b">Shortener + Qr generator</option>
            <option value="c">Shortener + Custom word</option>
            <option value="d">All options</option>

        </select>
        <button id="processButton">Process</button>
        <a id="downloadLink" style="display: none;" download="modified.csv">Download Modified CSV</a>
        <table id="output" style="display: none;"></table>
    </div>
    <script>
        const csvFileInput = document.getElementById('csvFile');
        const processButton = document.getElementById('processButton');
        const downloadLink = document.getElementById('downloadLink');
        const outputElement = document.getElementById('output');
        petitionData = new FormData();
        var sel = 1;
        var variableValue = 1;

        processButton.addEventListener('click', () => {


            const file = csvFileInput.files[0];
            if (file) { // Ensures there's an actual filed uploaded
                const reader = new FileReader();

                // We secure the values
                reader.onload = (event) => {
                csv = event.target.result;
                console.log("Csv value: " + csv);
                getValue();

                 // Obtenemos los datos del formulario y los adicionales
                 var dataCsv = $(this).serialize() + "&csv=" + encodeURIComponent(csv) + "&selector=" + encodeURIComponent(variableValue);
                console.log("Serialized data: " + dataCsv);

                 $.ajax({
                    type: "POST",
                    url: "/api/bulk",
                    data: dataCsv,
                    success: function (msg, status, request) {
                        csv = msg.csv;
                        console.log("Message: " + msg);

                        console.log("Csv: " + csv);

                        const blolb = new Blob([csv], {type: 'text/csv'}); // The data will be downloaded as a CSV file
                        downloadLink.href = URL.createObjectURL(blolb);
                        downloadLink.style.display = 'block';
                    },
                    error: function (request, status, error) {
                        // Aquí se maneja el error de la petición
                        console.error('Error:', error);
                    }
                });
                
                //const formData = new FormData();
                //formData.append('csv', csv);
                //formData.append('mode', variableValue);

                /*
                fetch("/api/bulk", {
                    method: "POST",
                    body: formData,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                    throw new Error(`HTTP error Status: ${response.status}`);
                    console.log("Error: " + response);
                    }
                    return response.json();
                })
                .then(data => {
                    csv = data;
                    console.log(csv);

                    const blolb = new Blob([csv], {type: 'text/csv'}); // The data will be downloaded as a CSV file
                    downloadLink.href = URL.createObjectURL(blolb);
                    downloadLink.style.display = 'block';
                })
                .catch(error => {
                    // Handle errors
                    console.error("Fetch error:", error);
                });
                */
                
            };

                reader.readAsText(file);
            }
        });

        function getValue() {
            // Get the selected value from the dropdown
            var selectedValue = document.getElementById("selector").value;

            // Use a switch statement to assign a corresponding variable
            
            switch (selectedValue) {
                case "a":
                    variableValue = 1;
                    break;
                case "b":
                    variableValue = 2;
                    break;
                case "c":
                    variableValue = 3;
                    break;
                case "d":
                    variableValue = 4;
                    break;
                default:
                    variableValue = 1; // Default value if none of the cases match
            }

            // Use the variableValue as needed
            console.log("Selected Value: " + variableValue);
        }
        
    </script>
</body>
</html>
