<!DOCTYPE html>
<html lang="es">
<head>
    <title>URL Shortener - CSV</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="webjars/bootstrap/3.4.0/css/bootstrap.min.css" rel="stylesheet"
          type="text/css"/>
    <script src="webjars/jquery/3.6.1/jquery.min.js" type="text/javascript"></script>
    <script src="webjars/bootstrap/3.4.0/js/bootstrap.min.js"
            type="text/javascript"></script>
    <script src="js/app.js" type="text/javascript">
    </script>
</head>
<body>
    <h1>Upload, Modify, and Download CSV Data</h1>
    <input type="file" id="csvFile" accept=".csv">
    <button id="processButton">Process</button>
    <a id="downloadLink" style="display: none;" download="modified.csv">Download Modified CSV</a>
    <table id="output" style="display: none;"></table>

    <script>
        const csvFileInput = document.getElementById('csvFile');
        const processButton = document.getElementById('processButton');
        const downloadLink = document.getElementById('downloadLink');
        const outputElement = document.getElementById('output');

        processButton.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (file) { // Ensures there's an actual filed uploaded
                const reader = new FileReader();

                reader.onload = (event) => {
                const csvData = event.target.result;
                const rows = csvData.split(/\n|;|\r/);

                console.log("Units: ", rows);

                // Create a download link for the modified data
                let modifiedData = '';
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    console.log("Original url: ", row);

                    const modifiedRow = row.split(',').map(cell => {
                        // Process individual cells here
                        if (cell === "") {
                            return "";
                        }

                        const tempCell = shortenUri(cell);

                        console.log(" InputCell: ", cell, " TempCell: ", tempCell);

                        if (cell === tempCell || tempCell === undefined) {
                            console.log("Do I exist?");
                            return "Uri_error";
                        } else {
                            return tempCell;
                        }
                    });

                    if (modifiedRow != ""){
                        modifiedData += modifiedRow.join(',') + '\n';
                    }
                }

                const blob = new Blob([modifiedData], { type: 'text/csv' }); // The data will be downloaded as a csv file
                downloadLink.href = URL.createObjectURL(blob);
                downloadLink.style.display = 'block';
            };

                reader.readAsText(file);
            }
        });

        // Modify the data in each cell as needed
        function modifyCell(cellData) {
            // Example: Convert each cell to uppercase
            return cellData.toUpperCase();
        }

        function shortenUri(cellData) {
            const originalUri = cellData;
            console.log("Cell: ", cellData, " vs Value: ", originalUri);

            // Bitly acces token, created on my account
            const accessToken = 'ed77cd0ebc778daa21631a8c9a9679b30da7dc20';

            // Bitly API endpoint
            const apiUrl = 'https://api-ssl.bitly.com/v4/shorten';

            // Prepare data for the API request
            const data = {
                long_url: originalUri,
            };

            // Make a POST request to the Bitly API
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`,
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                
                // Update the UI with the shortened URL
                 shortenedUri = data.link;
                
                if (shortenedUri == undefined){
                    shortenedUri = "uri_shortening_error";
                }

                console.log("Json gives us: ", shortenedUri);
                return shortenedUri;
            })
            .catch(error => {
                console.error('Error:', error)
                console.log("Json gives us an error");
                return "uri_shortening_error";
            });

            
        }
    </script>
</body>
</html>
